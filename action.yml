name: "Run ECS task"
description: "GitHub Action to run a task on Amazon ECS and output CloudWatch Logs"
author: kwood
branding:
  icon: "cloud"
  color: "orange"

inputs:
  region:
    description: "AWS Region"
    required: false
    default: "ap-northeast-1"
  copy-definition-from:
    required: false
    description: "The task family to copy the task definition from. Either this or `task-definition` is required."
  task-definition:
    required: false
    description: "The path to the task definition file"
  task-definition-family:
    description: "The name for your task definition"
    required: true
  launch-type:
    description: "Launch type"
    required: false
    default: "FARGATE"
  cluster:
    description: "ECS Cluster name"
    required: true
  subnets:
    description: "awsvpcConfiguration values: ['subnet-00', ...]"
    required: true
  security-groups:
    description: "awsvpcConfiguration values: ['sg-00', ...]"
    required: true
  assign-public-ip:
    description: "awsvpcConfiguration values"
    required: false
    default: "DISABLED"
  container-name:
    description: "The name of the container that run command. This parameter is required if any override is specified."
    required: false
  command:
    description: "Overrides the default command from the Docker image or the task definition. This parameter is required if any override is specified."
    required: false

outputs:
  task-id:
    description: "Task ID"
    value: ${{ steps.run-task.outputs.task_id }}
  revision:
    description: "Task definition's revision number"
    value: ${{ steps.task-def-register.outputs.revision }}
  logs:
    description: "CloudWatch Logs"
    value: ${{ steps.logs.outputs.out }}

runs:
  using: "composite"
  steps:
    - name: Install AWS CLI
      shell: bash
      run: |
        if ! [ -x "$(command -v aws)" ]; then
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip awscliv2.zip
          sudo ./aws/install --update
          awscli --version
        fi
    - name: Clone task definition from copy-definition-from
      shell: bash
      run: |
        if ! [ '${{ inputs.copy-definition-from }}' != '' ]
          aws ecs describe-task-definition --task-definition ${{inputs.copy-definition-from}} > /tmp/task-definition.json
        else
          cp ${{inputs.task-definition}} /tmp/task-definition.json
        fi
    - name: Register ECS task definition
      shell: bash
      id: task-def-register
      run: |
        revision=$(aws ecs register-task-definition \
          --region ${{ inputs.region }} \
          --family ${{ inputs.task-definition-family }} \
          --cli-input-json file:///tmp/task-definition.json \
          --query taskDefinition.revision)
        echo "::set-output name=revision::$revision"

    - name: Run ECS task
      shell: bash
      id: run-task
      env:
        vpc_configuration: "{subnets=${{ inputs.subnets }},securityGroups=${{ inputs.security-groups }},assignPublicIp=${{ inputs.assign-public-ip }}}"
        container_overrides: '{"containerOverrides": [{"name": "${{ inputs.container-name}}", "command": ${{ inputs.command }} }]}'
      run: |
        if [ '${{ inputs.container-name }}' != '' ] && [ '${{ inputs.command }}' != '' ]; then
          task_arn=$(aws ecs run-task \
            --region ${{ inputs.region }} \
            --launch-type ${{ inputs.launch-type }} \
            --cluster ${{ inputs.cluster }} \
            --network-configuration 'awsvpcConfiguration=${{ env.vpc_configuration }}' \
            --task-definition ${{ inputs.task-definition-family }}:${{ steps.task-def-register.outputs.revision }} \
            --overrides '${{ env.container_overrides }}' \
            --query tasks[0].taskArn --output text)
        else
          task_arn=$(aws ecs run-task \
            --region ${{ inputs.region }} \
            --launch-type ${{ inputs.launch-type }} \
            --cluster ${{ inputs.cluster }} \
            --network-configuration 'awsvpcConfiguration=${{ env.vpc_configuration }}' \
            --task-definition ${{ inputs.task-definition-family }}:${{ steps.task-def-register.outputs.revision }} \
            --query tasks[0].taskArn --output text)
        fi
        echo "::set-output name=task_arn::$task_arn"
        echo "::set-output name=task_id::${task_arn/*\//}"

    - name: Wait until a task stopped
      shell: bash
      run: |
        aws ecs wait tasks-stopped \
          --cluster ${{ inputs.cluster }} \
          --tasks ${{ steps.run-task.outputs.task_arn }}

    - name: Install ecs-cli
      shell: bash
      env:
        ecs_cli_version: v1.21.0
      run: |
        sudo curl -Lo /usr/local/bin/ecs-cli https://amazon-ecs-cli.s3.amazonaws.com/ecs-cli-linux-amd64-${{ env.ecs_cli_version }}
        sudo chmod +x /usr/local/bin/ecs-cli

    - name: Retrieve container logs from CloudWatch logs
      shell: bash
      id: logs
      run: |
        echo "::group::Retrieve container logs from CloudWatch logs"
        echo '::echo::on'
        out=$(ecs-cli logs --timestamps \
          --cluster ${{ inputs.cluster }} \
          --task-id ${{ steps.run-task.outputs.task_id }} \
          --task-def ${{ inputs.task-definition-family }}:${{ steps.task-def-register.outputs.revision }})
        out="${out//'%'/'%25'}"
        out="${out//$'\n'/'%0A'}"
        out="${out//$'\r'/'%0D'}"
        out="${out//$'^'/'d'}"
        echo "::set-output name=out::$out"
        echo "::endgroup::"

    - name: Check exit code in tasks
      shell: bash
      id: task-exit-code
      run: |
        exitCode=$(aws ecs describe-tasks \
          --region ${{ inputs.region }} \
          --cluster ${{ inputs.cluster }} \
          --tasks ${{ steps.run-task.outputs.task_arn }} \
          --query tasks[0].containers[0].exitCode \
          --output text)
        if [ "$exitCode" != "0" ]; then
          echo "detected run-task failure"
          exit $exitCode
        fi
